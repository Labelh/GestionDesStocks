import{u as H,a as U,j as e}from"./index-CXtSVrVw.js";import{u as K,r as c}from"./react-vendor-DRM3MNr6.js";import"./supabase-g_Un6fVd.js";const _=({cartItems:g,onComplete:k,onCancel:D})=>{var P;const T=K(),{currentUser:p,updateProduct:f,addStockMovement:F,getProductById:z,logout:A,addExitRequest:W}=H(),{addNotification:m}=U(),[y,S]=c.useState(0),[n,x]=c.useState(((P=g[0])==null?void 0:P.quantity)||1),[l,w]=c.useState(!1),[j,E]=c.useState(!1),[R,$]=c.useState("left"),[u,N]=c.useState(!1),[b,M]=c.useState(0),[C,I]=c.useState([]),i=g[y],v=g.length,q=y===v-1,a=i?z(i.productId):null,d=a?a.currentStock:(i==null?void 0:i.maxStock)||0,B=()=>{if(!i)return"Non spÃ©cifiÃ©";const t=i.storageZone||"",r=i.shelf||"",o=i.position||"";return`${t}.${r}.${o}`},Q=async()=>{if(!(!p||!a||n<=0||n>d)){w(!0);try{const t=a.currentStock-n;await f(a.id,{currentStock:t},!0),await F({productId:a.id,productReference:a.reference,productDesignation:a.designation,movementType:"exit",quantity:n,previousStock:a.currentStock,newStock:t,userId:p.id,userName:p.name,reason:"Sortie directe depuis le catalogue"}),I(r=>[...r,a.id]),q?E(!0):($("left"),setTimeout(()=>{var r;S(y+1),x(((r=g[y+1])==null?void 0:r.quantity)||1)},300))}catch(t){console.error("Erreur lors de la validation:",t),m({type:"error",title:"Erreur",message:"Impossible de valider la sortie",duration:5e3})}finally{w(!1)}}},V=()=>{E(!1),k()},L=async()=>{try{await A(),T("/badge-login")}catch(t){console.error("Erreur lors de la dÃ©connexion:",t),T("/badge-login")}},O=async()=>{if(!p||!a||b<=0){m({type:"error",title:"Erreur",message:"Veuillez renseigner une quantitÃ© valide",duration:5e3});return}w(!0);try{await W({productId:a.id,productReference:a.reference,productDesignation:a.designation,productPhoto:a.photo,quantity:b,reason:`Ã‰cart de stock signalÃ© - QuantitÃ© constatÃ©e: ${b}, Stock systÃ¨me: ${d}`,notes:"Ã‰cart signalÃ© lors d'une sortie"}),m({type:"info",title:"Ã‰cart signalÃ©",message:"Une demande de vÃ©rification a Ã©tÃ© envoyÃ©e au gestionnaire",duration:5e3}),N(!1),M(0)}catch(t){console.error("Erreur lors du signalement:",t),m({type:"error",title:"Erreur",message:"Impossible de signaler l'Ã©cart",duration:5e3})}finally{w(!1)}};return c.useEffect(()=>{const t=r=>{if(!(u||l)){if(j){r.key==="Enter"&&(r.preventDefault(),L());return}switch(r.key){case"ArrowRight":r.preventDefault(),n<d&&x(o=>Math.min(d,o+1));break;case"ArrowLeft":r.preventDefault(),n>1&&x(o=>Math.max(1,o-1));break;case"Enter":r.preventDefault(),!l&&n>0&&n<=d&&Q();break}}};return window.addEventListener("keydown",t),()=>window.removeEventListener("keydown",t)},[n,d,l,j,u]),j?e.jsx("div",{className:"exit-flow-overlay",children:e.jsxs("div",{className:"exit-flow-container completion-screen",children:[e.jsx("div",{className:"completion-icon",children:e.jsxs("svg",{width:"120",height:"120",viewBox:"0 0 24 24",fill:"none",stroke:"#10b981",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.2",fill:"#10b981"}),e.jsx("path",{d:"M7 13l3 3 7-7",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round"})]})}),e.jsx("h1",{className:"completion-title",children:"Sortie terminÃ©e !"}),e.jsxs("p",{className:"completion-message",children:[v," article",v>1?"s":""," sorti",v>1?"s":""," avec succÃ¨s par ",p==null?void 0:p.name]}),e.jsxs("div",{className:"completion-actions",children:[e.jsxs("button",{onClick:V,className:"btn-completion btn-new-exit",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M12 8v8m-4-4h8"})]}),"Nouvelle sortie"]}),e.jsxs("button",{onClick:L,className:"btn-completion btn-logout",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e.jsx("polyline",{points:"16 17 21 12 16 7"}),e.jsx("line",{x1:"21",y1:"12",x2:"9",y2:"12"})]}),"Se dÃ©connecter"]})]})]})}):i?e.jsxs("div",{className:"exit-flow-overlay",children:[e.jsxs("div",{className:`exit-flow-container ${R==="left"?"slide-left":"slide-right"}`,children:[e.jsxs("div",{className:"exit-flow-header",children:[e.jsxs("div",{className:"progress-info",children:[e.jsxs("span",{className:"progress-text",children:["Article ",y+1," sur ",v]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${(y+1)/v*100}%`}})})]}),e.jsx("button",{onClick:()=>D(C),className:"btn-close",title:"Annuler",children:"âœ•"})]}),e.jsx("h1",{style:{fontSize:"1.5rem",fontWeight:"700",color:"var(--text-color)",marginBottom:"1.5rem",textAlign:"center"},children:"Sortie d'article"}),e.jsxs("div",{className:"product-card-large",children:[e.jsx("div",{className:"product-image-large",children:i.photo?e.jsx("img",{src:i.photo,alt:i.productDesignation}):e.jsx("div",{className:"product-image-placeholder-large",children:e.jsx("svg",{width:"120",height:"120",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("path",{d:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"})})})}),e.jsxs("div",{className:"product-info-large",children:[e.jsx("div",{style:{fontSize:"1rem",fontWeight:"600",color:"#ff5722",marginBottom:"0.5rem"},children:i.productReference}),e.jsx("h2",{className:"product-designation-large",children:i.productDesignation}),e.jsxs("div",{className:"product-location-large",children:[e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"#9ca3af",strokeWidth:"2",children:[e.jsx("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e.jsx("circle",{cx:"12",cy:"10",r:"3"})]}),e.jsx("span",{children:B()})]}),e.jsxs("div",{className:"stock-info-large",children:[e.jsx("span",{className:"stock-label",style:{color:"#9ca3af"},children:"Stock disponible:"}),e.jsxs("span",{className:"stock-value-large",style:{color:"#9ca3af"},children:[d," ",i.unit||""]})]}),e.jsx("button",{onClick:()=>N(!0),style:{background:"transparent",border:"none",color:"#f59e0b",fontSize:"0.9rem",cursor:"pointer",textDecoration:"underline",marginTop:"0.5rem",padding:"0.25rem"},children:"un Ã©cart ?"}),e.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid var(--border-color)"},children:[e.jsx("label",{style:{fontSize:"0.85rem",color:"var(--text-secondary)",display:"block",marginBottom:"0.5rem"},children:"QuantitÃ© Ã  sortir"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[e.jsx("button",{onClick:()=>x(Math.max(1,n-1)),disabled:n<=1||l,style:{width:"32px",height:"32px",borderRadius:"6px",border:"1px solid var(--border-color)",background:"var(--input-bg)",color:"var(--text-color)",cursor:"pointer",fontSize:"1.25rem",display:"flex",alignItems:"center",justifyContent:"center"},children:"âˆ’"}),e.jsx("input",{type:"number",value:n,onChange:t=>{const r=parseInt(t.target.value)||1;x(Math.max(1,Math.min(r,d)))},min:"1",max:d,disabled:l,style:{flex:1,height:"32px",textAlign:"center",fontSize:"1rem",fontWeight:"600",border:"1px solid var(--border-color)",borderRadius:"6px",background:"var(--input-bg)",color:"var(--text-color)"}}),e.jsx("button",{onClick:()=>x(Math.min(d,n+1)),disabled:n>=d||l,style:{width:"32px",height:"32px",borderRadius:"6px",border:"1px solid var(--border-color)",background:"var(--input-bg)",color:"var(--text-color)",cursor:"pointer",fontSize:"1.25rem",display:"flex",alignItems:"center",justifyContent:"center"},children:"+"})]})]})]})]}),e.jsx("button",{className:"btn-validate-large",onClick:Q,disabled:l||n<=0||n>d,children:l?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner"}),"Traitement en cours..."]}):q?e.jsx(e.Fragment,{children:"âœ“ Valider et terminer"}):e.jsx(e.Fragment,{children:"âœ“ Valider cet article"})})]}),u&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2e3,padding:"1rem"},children:e.jsxs("div",{style:{background:"var(--card-bg)",borderRadius:"12px",padding:"1.5rem",maxWidth:"400px",width:"100%",border:"1px solid var(--border-color)"},children:[e.jsx("h3",{style:{marginBottom:"1rem",color:"var(--text-color)"},children:"Signaler un Ã©cart de stock"}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",marginBottom:"0.5rem",color:"var(--text-color)",fontSize:"0.9rem",fontWeight:"600"},children:"QuantitÃ© rÃ©ellement disponible *"}),e.jsx("input",{type:"number",value:b||"",onChange:t=>M(parseInt(t.target.value)||0),placeholder:"Ex: 10",min:"0",style:{width:"100%",padding:"0.75rem",background:"var(--input-bg)",border:"2px solid var(--border-color)",borderRadius:"8px",color:"var(--text-color)",fontSize:"1rem",outline:"none"}}),e.jsxs("p",{style:{fontSize:"0.8rem",color:"var(--text-secondary)",marginTop:"0.25rem"},children:["Stock systÃ¨me: ",d]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem"},children:[e.jsx("button",{onClick:()=>{N(!1),M(0)},style:{flex:1,padding:"0.75rem",background:"var(--bg-secondary)",color:"var(--text-color)",border:"1px solid var(--border-color)",borderRadius:"8px",cursor:"pointer",fontSize:"0.95rem",fontWeight:"600"},children:"Annuler"}),e.jsx("button",{onClick:O,disabled:l,style:{flex:1,padding:"0.75rem",background:"#f59e0b",color:"white",border:"none",borderRadius:"8px",cursor:l?"not-allowed":"pointer",fontSize:"0.95rem",fontWeight:"600",opacity:l?.6:1},children:l?"Envoi...":"Signaler"})]})]})})]}):null},Y=()=>{const{products:g,currentUser:k,stockMovements:D,loading:T,getPendingOrders:p,userCart:f,addToUserCart:F,removeFromUserCart:z,clearUserCart:A}=H(),{addNotification:W}=U(),[m,y]=c.useState("all"),[S,n]=c.useState(""),[x,l]=c.useState({}),[w,j]=c.useState(!1),[E,R]=c.useState({}),$=t=>p().filter(o=>o.product_id===t).reduce((o,s)=>o+s.quantity,0),u=g,N=c.useMemo(()=>{if(!k)return[];const t=D.filter(s=>s.movementType==="exit"&&s.userId===k.id),r={};t.forEach(s=>{r[s.productId]=(r[s.productId]||0)+s.quantity});const o=Object.entries(r).sort(([,s],[,h])=>h-s).slice(0,10).map(([s])=>s);return u.filter(s=>o.includes(s.id))},[u,D,k]),b=c.useMemo(()=>{let t=u;if(m==="top-ordered"?t=N:m!=="all"&&(t=u.filter(r=>r.category===m)),S.trim()){const r=S.toLowerCase();t=t.filter(o=>o.reference.toLowerCase().includes(r)||o.designation.toLowerCase().includes(r))}return t},[u,m,N,S]),M=c.useMemo(()=>["all","top-ordered",...new Set(u.map(r=>r.category))],[u]),C=t=>x[t]||1,I=(t,r)=>{const o=g.find(Z=>Z.id===t);if(!o)return;const s=o.currentStock,h=Math.max(1,Math.min(r,s));l({...x,[t]:h})},i=t=>{I(t,C(t)+1)},v=t=>{I(t,C(t)-1)},q=t=>{const r=f.find(o=>o.productId===t);return r?r.quantity:0},a=async t=>{const r=g.find(h=>h.id===t);if(!r)return;const o=C(t),s=q(t);if(s+o>r.currentStock){alert(`Stock insuffisant ! Disponible: ${r.currentStock}, DÃ©jÃ  dans le panier: ${s}`);return}R(h=>({...h,[t]:!0}));try{await F({productId:r.id,productReference:r.reference,productDesignation:r.designation,quantity:o,maxStock:r.currentStock,photo:r.photo,storageZone:r.storageZone,shelf:r.shelf,position:r.position,unit:r.unit}),l({...x,[t]:1})}catch(h){console.error("Erreur lors de l'ajout au panier:",h),alert("Erreur lors de l'ajout au panier")}R(h=>({...h,[t]:!1}))},d=async t=>{try{await z(t)}catch(r){console.error("Erreur lors de la suppression du panier:",r),alert("Erreur lors de la suppression de l'article")}},B=async()=>{try{await A()}catch(t){console.error("Erreur lors du vidage du panier:",t),alert("Erreur lors du vidage du panier")}},Q=()=>{!k||f.length===0||j(!0)},V=()=>{j(!1),B(),W({type:"success",title:"Sortie terminÃ©e !",message:"Tous les articles ont Ã©tÃ© sortis avec succÃ¨s",duration:5e3})},L=async t=>{if(j(!1),t.length>0)try{for(const r of t)await z(r);W({type:"info",title:"Sortie annulÃ©e",message:`${t.length} article(s) ont Ã©tÃ© sortis avant l'annulation`,duration:5e3})}catch(r){console.error("Erreur lors de la mise Ã  jour du panier:",r)}},O=()=>f.reduce((t,r)=>t+r.quantity,0),P=t=>{const r=t.currentStock/t.maxStock;return t.currentStock===0||r<=.2?"critical":r<=.4?"low":"normal"};return T?e.jsxs("div",{className:"catalog-container",style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"60vh",gap:"1.5rem"},children:[e.jsxs("svg",{width:"80",height:"80",viewBox:"0 0 24 24",fill:"none",stroke:"var(--accent-color)",strokeWidth:"2",style:{animation:"spin 1s linear infinite"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",strokeLinecap:"round"})]}),e.jsx("p",{style:{fontSize:"1.25rem",color:"var(--text-secondary)",fontWeight:"500"},children:"Chargement du catalogue..."})]}):e.jsxs("div",{className:"catalog-container",children:[e.jsx("h1",{children:"Catalogue des Produits"}),e.jsxs("div",{style:{marginBottom:"1.5rem",display:"flex",gap:"1rem",alignItems:"center"},children:[e.jsx("input",{type:"text",placeholder:"Rechercher par rÃ©fÃ©rence ou dÃ©signation...",value:S,onChange:t=>n(t.target.value),style:{flex:1,padding:"0.875rem 1rem",fontSize:"1rem",border:"2px solid var(--border-color)",borderRadius:"8px",background:"var(--input-bg)",color:"var(--text-color)",outline:"none",transition:"border-color 0.2s"},onFocus:t=>t.currentTarget.style.borderColor="var(--accent-color)",onBlur:t=>t.currentTarget.style.borderColor="var(--border-color)"}),e.jsx("select",{value:m,onChange:t=>y(t.target.value),style:{padding:"0.875rem 1rem",fontSize:"1rem",border:"2px solid var(--border-color)",borderRadius:"8px",background:"var(--bg-color)",color:"#ffffff",outline:"none",cursor:"pointer",minWidth:"200px",transition:"border-color 0.2s"},onFocus:t=>t.currentTarget.style.borderColor="var(--accent-color)",onBlur:t=>t.currentTarget.style.borderColor="var(--border-color)",children:M.map(t=>e.jsx("option",{value:t,style:{background:"var(--bg-color)",color:"#ffffff"},children:t==="all"?"Toutes les catÃ©gories":t==="top-ordered"?"Les plus utilisÃ©es":t},t))})]}),b.length===0?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"40vh",gap:"1rem"},children:[e.jsxs("svg",{width:"60",height:"60",viewBox:"0 0 24 24",fill:"none",stroke:"var(--accent-color)",strokeWidth:"2",style:{animation:"spin 1s linear infinite"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",strokeLinecap:"round"})]}),e.jsx("p",{style:{fontSize:"1rem",color:"var(--text-secondary)",fontWeight:"500"},children:"Aucun produit dans cette catÃ©gorie"})]}):e.jsx("div",{className:"products-grid",children:b.map(t=>{const r=P(t),o=C(t.id);return e.jsxs("div",{className:"product-card",children:[e.jsxs("div",{className:"product-image-wrapper",children:[e.jsx("span",{className:"product-category-badge",children:t.category}),t.photo?e.jsx("img",{src:t.photo,alt:t.designation,className:"product-image"}):e.jsx("div",{className:"product-image-placeholder",children:"ðŸ“¦"})]}),e.jsxs("div",{className:"product-details",children:[e.jsx("div",{className:"product-ref",children:t.reference}),e.jsx("h3",{className:"product-name",children:t.designation}),e.jsxs("div",{className:"product-stock-inline",children:["QuantitÃ© : ",e.jsx("span",{className:r,children:t.currentStock})]}),(()=>{const s=$(t.id);return e.jsx("span",{style:{display:"inline-block",padding:"0.125rem 0.5rem",fontSize:"0.7rem",fontWeight:"600",color:s>0?"#fff":"transparent",background:s>0?"#10b981":"transparent",borderRadius:"4px",marginTop:"0.25rem",width:"fit-content",visibility:s>0?"visible":"hidden"},children:s>0?`En commande x${s}`:"Spacer"})})(),e.jsxs("div",{className:"product-actions",children:[e.jsxs("div",{className:"quantity-selector",children:[e.jsx("button",{className:"quantity-btn",onClick:()=>v(t.id),disabled:o<=1,children:"âˆ’"}),e.jsx("input",{type:"number",className:"quantity-input",value:o,onChange:s=>I(t.id,parseInt(s.target.value)||1),min:"1",max:t.currentStock}),e.jsx("button",{className:"quantity-btn",onClick:()=>i(t.id),disabled:o>=t.currentStock,children:"+"})]}),t.currentStock>0?e.jsx("button",{className:"add-to-cart-btn-icon",onClick:()=>a(t.id),title:"Ajouter au panier",disabled:E[t.id],children:E[t.id]?e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{animation:"spin 0.8s linear infinite"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",strokeLinecap:"round"})]}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"9",cy:"21",r:"1"}),e.jsx("circle",{cx:"20",cy:"21",r:"1"}),e.jsx("path",{d:"M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"})]})}):e.jsx("button",{className:"add-to-cart-btn-icon",disabled:!0,title:"Stock Ã©puisÃ©",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"9",cy:"21",r:"1"}),e.jsx("circle",{cx:"20",cy:"21",r:"1"}),e.jsx("path",{d:"M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"})]})})]})]})]},t.id)})}),f.length>0&&e.jsxs("div",{className:"fixed-cart",children:[e.jsxs("div",{className:"cart-header",children:[e.jsx("h2",{children:"Mon Panier"}),e.jsxs("span",{className:"cart-count",children:[O()," articles"]})]}),e.jsx("div",{className:"cart-items",children:f.map(t=>e.jsxs("div",{className:"cart-item",children:[t.photo?e.jsx("img",{src:t.photo,alt:t.productDesignation,className:"cart-item-image"}):e.jsx("div",{className:"cart-item-image",children:"ðŸ“¦"}),e.jsxs("div",{className:"cart-item-details",children:[e.jsx("div",{className:"cart-item-ref product-reference-highlight",children:t.productReference}),e.jsx("div",{className:"cart-item-name",children:t.productDesignation}),e.jsxs("div",{className:"cart-item-quantity",children:[e.jsx("span",{children:"QuantitÃ©:"}),e.jsx("strong",{children:t.quantity})]})]}),e.jsx("button",{className:"remove-item-btn",onClick:()=>d(t.productId),title:"Retirer du panier",children:"Ã—"})]},t.productId))}),e.jsxs("div",{className:"cart-footer",children:[e.jsx("button",{className:"empty-cart-btn",onClick:B,children:"Vider le panier"}),e.jsx("button",{className:"submit-cart-btn",onClick:Q,children:"Effectuer la sortie"})]})]}),w&&e.jsx(_,{cartItems:f,onComplete:V,onCancel:L})]})};export{Y as default};
