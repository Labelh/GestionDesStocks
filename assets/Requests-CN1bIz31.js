import{u as N,j as e}from"./index-QTtNBvix.js";import{r as a,R as C}from"./react-vendor-DRM3MNr6.js";import"./supabase-g_Un6fVd.js";const z=()=>{const{exitRequests:j,updateExitRequest:u,currentUser:o,getProductById:v}=N(),[h,y]=a.useState("pending"),[l,d]=a.useState(null),[b,x]=a.useState(null),[p,m]=a.useState(""),g=h?j.filter(t=>t.status===h):j,i=a.useMemo(()=>{const t=new Map;return g.forEach(s=>{const r=`${s.requestedBy}-${new Date(s.requestedAt).toISOString().slice(0,16)}`;t.has(r)||t.set(r,[]),t.get(r).push(s)}),t},[g]),f=a.useMemo(()=>Array.from(i.entries()).sort((t,s)=>{const r=new Date(t[1][0].requestedAt).getTime();return new Date(s[1][0].requestedAt).getTime()-r}),[i]),k=a.useCallback(async t=>{const s=i.get(t);if(!s)return;const r=s.filter(n=>n.status==="pending");if(r.length===0){alert("Aucune demande en attente dans ce panier");return}if(window.confirm(`Approuver ${r.length} demande(s) de ce panier ?`))try{for(const n of r)await u(n.id,{status:"approved",approvedBy:o==null?void 0:o.id,approvedAt:new Date});d(null)}catch(n){console.error("Erreur lors de l'approbation:",n),alert("Erreur lors de l'approbation du panier")}},[i,u,o]),S=a.useCallback(async t=>{if(!p.trim()){alert("Veuillez indiquer la raison du refus");return}const s=i.get(t);if(!s)return;const r=s.filter(n=>n.status==="pending");if(r.length===0){alert("Aucune demande en attente dans ce panier");return}try{for(const n of r)await u(n.id,{status:"rejected",approvedBy:o==null?void 0:o.id,approvedAt:new Date,notes:p});x(null),d(null),m("")}catch(n){console.error("Erreur lors du refus:",n),alert("Erreur lors du refus du panier")}},[i,p,u,o]),R=a.useCallback(t=>{const s=t.map(r=>r.status);return s.every(r=>r==="approved")?"approved":s.every(r=>r==="rejected")?"rejected":s.every(r=>r==="pending")?"pending":"mixed"},[]);return e.jsxs("div",{className:"requests-page",children:[e.jsx("h1",{children:"Demandes de vÃ©rification"}),e.jsx("div",{className:"filters",children:e.jsxs("select",{value:h,onChange:t=>y(t.target.value),className:"filter-select",children:[e.jsx("option",{value:"",children:"Tous les statuts"}),e.jsx("option",{value:"pending",children:"En attente"}),e.jsx("option",{value:"approved",children:"ApprouvÃ©es"}),e.jsx("option",{value:"rejected",children:"RefusÃ©es"})]})}),f.length===0?e.jsx("p",{className:"no-data",children:"Aucune demande trouvÃ©e"}):e.jsx("div",{className:"products-table-container",children:e.jsxs("table",{className:"products-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date de la demande"}),e.jsx("th",{children:"DemandÃ© par"}),e.jsx("th",{children:"Nombre d'articles"}),e.jsx("th",{children:"QuantitÃ© totale"}),e.jsx("th",{children:"Statut"}),e.jsx("th",{children:"Actions"})]})}),e.jsx("tbody",{children:f.map(([t,s])=>{const r=R(s),n=s[0],w=s.some(c=>c.status==="pending"),A=s.reduce((c,B)=>c+B.quantity,0);return e.jsxs(C.Fragment,{children:[e.jsxs("tr",{children:[e.jsxs("td",{children:[new Date(n.requestedAt).toLocaleDateString("fr-FR")," Ã "," ",new Date(n.requestedAt).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})]}),e.jsx("td",{children:n.requestedBy}),e.jsxs("td",{children:[s.length," article",s.length>1?"s":""]}),e.jsx("td",{children:A}),e.jsx("td",{children:e.jsxs("span",{className:`stock-value stock-${r}`,children:[r==="pending"&&"En attente",r==="approved"&&"ApprouvÃ©",r==="rejected"&&"RefusÃ©",r==="mixed"&&"Mixte"]})}),e.jsx("td",{children:e.jsxs("div",{className:"actions",children:[e.jsx("button",{onClick:()=>d(l===t?null:t),className:"btn-icon btn-edit",title:"Voir dÃ©tails",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"}),e.jsx("circle",{cx:"12",cy:"12",r:"3"})]})}),w&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>k(t),className:"btn-icon btn-approve",title:"Approuver le panier",children:e.jsx("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:e.jsx("polyline",{points:"20 6 9 17 4 12"})})}),e.jsx("button",{onClick:()=>x(t),className:"btn-icon btn-reject",title:"Refuser le panier",children:e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2.5",strokeLinecap:"round",strokeLinejoin:"round",children:[e.jsx("line",{x1:"18",y1:"6",x2:"6",y2:"18"}),e.jsx("line",{x1:"6",y1:"6",x2:"18",y2:"18"})]})})]})]})})]}),b===t&&e.jsx("tr",{children:e.jsx("td",{colSpan:6,style:{padding:"1rem",background:"var(--card-bg)"},children:e.jsxs("div",{className:"reject-form",style:{margin:0},children:[e.jsx("textarea",{placeholder:"Raison du refus...",value:p,onChange:c=>m(c.target.value),rows:3,style:{width:"100%",marginBottom:"0.5rem"}}),e.jsxs("div",{className:"reject-actions",style:{display:"flex",gap:"0.5rem",justifyContent:"flex-end"},children:[e.jsx("button",{onClick:()=>{x(null),m("")},className:"btn btn-secondary",children:"Annuler"}),e.jsx("button",{onClick:()=>S(t),className:"btn btn-danger",children:"Confirmer le Refus"})]})]})})})]},t)})})]})}),l&&e.jsx("div",{className:"modal-overlay",onClick:()=>d(null),children:e.jsxs("div",{className:"modal",onClick:t=>t.stopPropagation(),style:{maxWidth:"900px"},children:[e.jsx("h2",{children:"DÃ©tails du Panier"}),e.jsxs("p",{style:{marginBottom:"1.5rem",color:"var(--text-secondary)"},children:["DemandÃ© par ",i.get(l)[0].requestedBy," le ",new Date(i.get(l)[0].requestedAt).toLocaleString("fr-FR")]}),e.jsx("div",{style:{display:"flex",flexDirection:"column",gap:"1rem",maxHeight:"500px",overflowY:"auto"},children:i.get(l).map(t=>{const s=v(t.productId),r=s&&s.currentStock<t.quantity;return e.jsxs("div",{style:{display:"flex",gap:"1rem",padding:"1rem",background:"var(--card-bg)",borderRadius:"8px",border:r?"2px solid #f59e0b":"1px solid var(--border-color)",alignItems:"center"},children:[s&&s.photo?e.jsx("img",{src:s.photo,alt:t.productDesignation,style:{width:"100px",height:"100px",objectFit:"cover",borderRadius:"8px"}}):e.jsx("div",{style:{width:"100px",height:"100px",display:"flex",alignItems:"center",justifyContent:"center",background:"var(--bg-secondary)",borderRadius:"8px",fontSize:"2.5rem"},children:"ðŸ“¦"}),e.jsxs("div",{style:{flex:1},children:[e.jsx("h3",{style:{margin:"0 0 0.5rem 0",fontSize:"1.2rem"},children:t.productDesignation}),e.jsx("p",{style:{margin:"0.25rem 0",color:"var(--text-secondary)",fontSize:"0.9rem"},children:t.productReference}),e.jsxs("p",{style:{margin:"0.25rem 0",fontSize:"1rem"},children:[e.jsx("strong",{children:"QuantitÃ© demandÃ©e:"})," ",t.quantity," ",s==null?void 0:s.unit]}),s&&e.jsxs("p",{style:{margin:"0.25rem 0",fontSize:"0.95rem",color:r?"#f59e0b":"var(--text-color)"},children:[e.jsx("strong",{children:"Stock actuel:"})," ",s.currentStock," ",s.unit,r&&" âš ï¸ Stock insuffisant"]}),t.status==="rejected"&&t.notes&&e.jsxs("p",{style:{margin:"0.5rem 0 0 0",color:"#ef4444",fontSize:"0.9rem"},children:[e.jsx("strong",{children:"Raison du refus:"})," ",t.notes]})]})]},t.id)})}),e.jsx("div",{className:"modal-actions",style:{marginTop:"1.5rem"},children:e.jsx("button",{onClick:()=>d(null),className:"btn btn-secondary",children:"Fermer"})})]})})]})};export{z as default};
