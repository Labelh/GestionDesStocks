import{u as O,a as H,j as e}from"./index-BHdnVhBT.js";import{u as Z,r as c}from"./react-vendor-DRM3MNr6.js";import"./supabase-g_Un6fVd.js";const U=({cartItems:y,onComplete:N,onCancel:D})=>{var r;const T=Z(),{currentUser:p,updateProduct:q,addStockMovement:b,getProductById:L,logout:w,addExitRequest:P}=O(),{addNotification:u}=H(),[x,I]=c.useState(0),[o,v]=c.useState(((r=y[0])==null?void 0:r.quantity)||1),[l,k]=c.useState(!1),[C,z]=c.useState(!1),[g,W]=c.useState("left"),[E,M]=c.useState(!1),[f,S]=c.useState(0),[A,F]=c.useState([]),i=y[x],j=y.length,R=x===j-1,a=i?L(i.productId):null,h=a?a.currentStock:(i==null?void 0:i.maxStock)||0,$=()=>{if(!i)return"Non spÃ©cifiÃ©";const n=i.storageZone||"",s=i.shelf||"",m=i.position||"";return`${n}.${s}.${m}`},B=async()=>{if(!(!p||!a||o<=0||o>h)){k(!0);try{const n=a.currentStock-o;await q(a.id,{currentStock:n},!0),await b({productId:a.id,productReference:a.reference,productDesignation:a.designation,movementType:"exit",quantity:o,previousStock:a.currentStock,newStock:n,userId:p.id,userName:p.name,reason:"Sortie directe depuis le catalogue"}),F(s=>[...s,a.id]),R?z(!0):(W("left"),setTimeout(()=>{var s;I(x+1),v(((s=y[x+1])==null?void 0:s.quantity)||1)},300))}catch(n){console.error("Erreur lors de la validation:",n),u({type:"error",title:"Erreur",message:"Impossible de valider la sortie",duration:5e3})}finally{k(!1)}}},V=()=>{z(!1),N()},Q=async()=>{try{await w(),T("/badge-login")}catch(n){console.error("Erreur lors de la dÃ©connexion:",n),T("/badge-login")}},t=async()=>{if(!p||!a||f<=0){u({type:"error",title:"Erreur",message:"Veuillez renseigner une quantitÃ© valide",duration:5e3});return}k(!0);try{await P({productId:a.id,productReference:a.reference,productDesignation:a.designation,productPhoto:a.photo,quantity:f,reason:`Ã‰cart de stock signalÃ© - QuantitÃ© constatÃ©e: ${f}, Stock systÃ¨me: ${h}`,notes:"Ã‰cart signalÃ© lors d'une sortie"}),u({type:"info",title:"Ã‰cart signalÃ©",message:"Une demande de vÃ©rification a Ã©tÃ© envoyÃ©e au gestionnaire",duration:5e3}),M(!1),S(0)}catch(n){console.error("Erreur lors du signalement:",n),u({type:"error",title:"Erreur",message:"Impossible de signaler l'Ã©cart",duration:5e3})}finally{k(!1)}};return c.useEffect(()=>{const n=s=>{if(!(E||l)){if(C){s.key==="Enter"&&(s.preventDefault(),Q());return}switch(s.key){case"ArrowRight":s.preventDefault(),o<h&&v(m=>Math.min(h,m+1));break;case"ArrowLeft":s.preventDefault(),o>1&&v(m=>Math.max(1,m-1));break;case"Enter":s.preventDefault(),!l&&o>0&&o<=h&&B();break}}};return window.addEventListener("keydown",n),()=>window.removeEventListener("keydown",n)},[o,h,l,C,E]),C?e.jsx("div",{className:"exit-flow-overlay",children:e.jsxs("div",{className:"exit-flow-container completion-screen",children:[e.jsx("div",{className:"completion-icon",children:e.jsxs("svg",{width:"120",height:"120",viewBox:"0 0 24 24",fill:"none",stroke:"#10b981",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.2",fill:"#10b981"}),e.jsx("path",{d:"M7 13l3 3 7-7",strokeWidth:"3",strokeLinecap:"round",strokeLinejoin:"round"})]})}),e.jsx("h1",{className:"completion-title",children:"Sortie terminÃ©e !"}),e.jsxs("p",{className:"completion-message",children:[j," article",j>1?"s":""," sorti",j>1?"s":""," avec succÃ¨s par ",p==null?void 0:p.name]}),e.jsxs("div",{className:"completion-actions",children:[e.jsxs("button",{onClick:V,className:"btn-completion btn-new-exit",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"12",cy:"12",r:"10"}),e.jsx("path",{d:"M12 8v8m-4-4h8"})]}),"Nouvelle sortie"]}),e.jsxs("button",{onClick:Q,className:"btn-completion btn-logout",children:[e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"}),e.jsx("polyline",{points:"16 17 21 12 16 7"}),e.jsx("line",{x1:"21",y1:"12",x2:"9",y2:"12"})]}),"Se dÃ©connecter"]})]})]})}):i?e.jsxs("div",{className:"exit-flow-overlay",children:[e.jsxs("div",{className:`exit-flow-container ${g==="left"?"slide-left":"slide-right"}`,children:[e.jsxs("div",{className:"exit-flow-header",children:[e.jsxs("div",{className:"progress-info",children:[e.jsxs("span",{className:"progress-text",children:["Article ",x+1," sur ",j]}),e.jsx("div",{className:"progress-bar",children:e.jsx("div",{className:"progress-fill",style:{width:`${(x+1)/j*100}%`}})})]}),e.jsx("button",{onClick:()=>D(A),className:"btn-close",title:"Annuler",children:"âœ•"})]}),e.jsx("h1",{style:{fontSize:"1.5rem",fontWeight:"700",color:"var(--text-color)",marginBottom:"1.5rem",textAlign:"center"},children:"Sortie d'article"}),e.jsxs("div",{className:"product-card-large",children:[e.jsx("div",{className:"product-image-large",children:i.photo?e.jsx("img",{src:i.photo,alt:i.productDesignation}):e.jsx("div",{className:"product-image-placeholder-large",children:e.jsx("svg",{width:"120",height:"120",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"1.5",children:e.jsx("path",{d:"M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"})})})}),e.jsxs("div",{className:"product-info-large",children:[e.jsx("div",{style:{fontSize:"1rem",fontWeight:"600",color:"#ff5722",marginBottom:"0.5rem"},children:i.productReference}),e.jsx("h2",{className:"product-designation-large",children:i.productDesignation}),e.jsxs("div",{className:"product-location-large",children:[e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"#9ca3af",strokeWidth:"2",children:[e.jsx("path",{d:"M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"}),e.jsx("circle",{cx:"12",cy:"10",r:"3"})]}),e.jsx("span",{children:$()})]}),e.jsxs("div",{className:"stock-info-large",children:[e.jsx("span",{className:"stock-label",style:{color:"#9ca3af"},children:"Stock disponible:"}),e.jsxs("span",{className:"stock-value-large",style:{color:"#9ca3af"},children:[h," ",i.unit||""]})]}),e.jsx("button",{onClick:()=>M(!0),style:{background:"transparent",border:"none",color:"#f59e0b",fontSize:"0.9rem",cursor:"pointer",textDecoration:"underline",marginTop:"0.5rem",padding:"0.25rem"},children:"un Ã©cart ?"}),e.jsxs("div",{style:{marginTop:"1.5rem",paddingTop:"1rem",borderTop:"1px solid var(--border-color)"},children:[e.jsx("label",{style:{fontSize:"0.85rem",color:"var(--text-secondary)",display:"block",marginBottom:"0.5rem"},children:"QuantitÃ© Ã  sortir"}),e.jsxs("div",{style:{display:"flex",gap:"0.5rem",alignItems:"center"},children:[e.jsx("button",{onClick:()=>v(Math.max(1,o-1)),disabled:o<=1||l,style:{width:"32px",height:"32px",borderRadius:"6px",border:"1px solid var(--border-color)",background:"var(--input-bg)",color:"var(--text-color)",cursor:"pointer",fontSize:"1.25rem",display:"flex",alignItems:"center",justifyContent:"center"},children:"âˆ’"}),e.jsx("input",{type:"number",value:o,onChange:n=>{const s=parseInt(n.target.value)||1;v(Math.max(1,Math.min(s,h)))},min:"1",max:h,disabled:l,style:{flex:1,height:"32px",textAlign:"center",fontSize:"1rem",fontWeight:"600",border:"1px solid var(--border-color)",borderRadius:"6px",background:"var(--input-bg)",color:"var(--text-color)"}}),e.jsx("button",{onClick:()=>v(Math.min(h,o+1)),disabled:o>=h||l,style:{width:"32px",height:"32px",borderRadius:"6px",border:"1px solid var(--border-color)",background:"var(--input-bg)",color:"var(--text-color)",cursor:"pointer",fontSize:"1.25rem",display:"flex",alignItems:"center",justifyContent:"center"},children:"+"})]})]})]})]}),e.jsx("button",{className:"btn-validate-large",onClick:B,disabled:l||o<=0||o>h,children:l?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"spinner"}),"Traitement en cours..."]}):R?e.jsx(e.Fragment,{children:"âœ“ Valider et terminer"}):e.jsx(e.Fragment,{children:"âœ“ Valider cet article"})})]}),E&&e.jsx("div",{style:{position:"fixed",top:0,left:0,right:0,bottom:0,background:"rgba(0, 0, 0, 0.5)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:2e3,padding:"1rem"},children:e.jsxs("div",{style:{background:"var(--card-bg)",borderRadius:"12px",padding:"1.5rem",maxWidth:"400px",width:"100%",border:"1px solid var(--border-color)"},children:[e.jsx("h3",{style:{marginBottom:"1rem",color:"var(--text-color)"},children:"Signaler un Ã©cart de stock"}),e.jsxs("div",{style:{marginBottom:"1rem"},children:[e.jsx("label",{style:{display:"block",marginBottom:"0.5rem",color:"var(--text-color)",fontSize:"0.9rem",fontWeight:"600"},children:"QuantitÃ© rÃ©ellement disponible *"}),e.jsx("input",{type:"number",value:f||"",onChange:n=>S(parseInt(n.target.value)||0),placeholder:"Ex: 10",min:"0",style:{width:"100%",padding:"0.75rem",background:"var(--input-bg)",border:"2px solid var(--border-color)",borderRadius:"8px",color:"var(--text-color)",fontSize:"1rem",outline:"none"}}),e.jsxs("p",{style:{fontSize:"0.8rem",color:"var(--text-secondary)",marginTop:"0.25rem"},children:["Stock systÃ¨me: ",h]})]}),e.jsxs("div",{style:{display:"flex",gap:"0.75rem"},children:[e.jsx("button",{onClick:()=>{M(!1),S(0)},style:{flex:1,padding:"0.75rem",background:"var(--bg-secondary)",color:"var(--text-color)",border:"1px solid var(--border-color)",borderRadius:"8px",cursor:"pointer",fontSize:"0.95rem",fontWeight:"600"},children:"Annuler"}),e.jsx("button",{onClick:t,disabled:l,style:{flex:1,padding:"0.75rem",background:"#f59e0b",color:"white",border:"none",borderRadius:"8px",cursor:l?"not-allowed":"pointer",fontSize:"0.95rem",fontWeight:"600",opacity:l?.6:1},children:l?"Envoi...":"Signaler"})]})]})})]}):null},J=()=>{const{products:y,currentUser:N,stockMovements:D,loading:T,getPendingOrders:p}=O(),{addNotification:q}=H(),[b,L]=c.useState("all"),[w,P]=c.useState(""),[u,x]=c.useState([]),[I,o]=c.useState({}),[v,l]=c.useState(!1),[k,C]=c.useState({}),z=t=>p().filter(n=>n.product_id===t).reduce((n,s)=>n+s.quantity,0),g=y,W=c.useMemo(()=>{if(!N)return[];const t=D.filter(s=>s.movementType==="exit"&&s.userId===N.id),r={};t.forEach(s=>{r[s.productId]=(r[s.productId]||0)+s.quantity});const n=Object.entries(r).sort(([,s],[,m])=>m-s).slice(0,10).map(([s])=>s);return g.filter(s=>n.includes(s.id))},[g,D,N]),E=c.useMemo(()=>{let t=g;if(b==="top-ordered"?t=W:b!=="all"&&(t=g.filter(r=>r.category===b)),w.trim()){const r=w.toLowerCase();t=t.filter(n=>n.reference.toLowerCase().includes(r)||n.designation.toLowerCase().includes(r))}return t},[g,b,W,w]),M=c.useMemo(()=>["all","top-ordered",...new Set(g.map(r=>r.category))],[g]),f=t=>I[t]||1,S=(t,r)=>{const n=y.find(d=>d.id===t);if(!n)return;const s=n.currentStock,m=Math.max(1,Math.min(r,s));o({...I,[t]:m})},A=t=>{S(t,f(t)+1)},F=t=>{S(t,f(t)-1)},i=t=>{const r=u.find(n=>n.productId===t);return r?r.quantity:0},j=async t=>{const r=y.find(d=>d.id===t);if(!r)return;const n=f(t),s=i(t);if(s+n>r.currentStock){alert(`Stock insuffisant ! Disponible: ${r.currentStock}, DÃ©jÃ  dans le panier: ${s}`);return}C(d=>({...d,[t]:!0})),await new Promise(d=>setTimeout(d,300));const m=u.find(d=>d.productId===t);x(m?u.map(d=>d.productId===t?{...d,quantity:d.quantity+n}:d):[...u,{productId:r.id,productReference:r.reference,productDesignation:r.designation,quantity:n,maxStock:r.currentStock,photo:r.photo,storageZone:r.storageZone,shelf:r.shelf,position:r.position,unit:r.unit}]),o({...I,[t]:1}),C(d=>({...d,[t]:!1}))},R=t=>{x(u.filter(r=>r.productId!==t))},a=()=>{x([])},h=()=>{!N||u.length===0||l(!0)},$=()=>{l(!1),a(),q({type:"success",title:"Sortie terminÃ©e !",message:"Tous les articles ont Ã©tÃ© sortis avec succÃ¨s",duration:5e3})},B=t=>{l(!1),t.length>0&&(x(r=>r.filter(n=>!t.includes(n.productId))),q({type:"info",title:"Sortie annulÃ©e",message:`${t.length} article(s) ont Ã©tÃ© sortis avant l'annulation`,duration:5e3}))},V=()=>u.reduce((t,r)=>t+r.quantity,0),Q=t=>{const r=t.currentStock/t.maxStock;return t.currentStock===0||r<=.2?"critical":r<=.4?"low":"normal"};return T?e.jsxs("div",{className:"catalog-container",style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"60vh",gap:"1.5rem"},children:[e.jsxs("svg",{width:"80",height:"80",viewBox:"0 0 24 24",fill:"none",stroke:"var(--accent-color)",strokeWidth:"2",style:{animation:"spin 1s linear infinite"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",strokeLinecap:"round"})]}),e.jsx("p",{style:{fontSize:"1.25rem",color:"var(--text-secondary)",fontWeight:"500"},children:"Chargement du catalogue..."})]}):e.jsxs("div",{className:"catalog-container",children:[e.jsx("h1",{children:"Catalogue des Produits"}),e.jsxs("div",{style:{marginBottom:"1.5rem",display:"flex",gap:"1rem",alignItems:"center"},children:[e.jsx("input",{type:"text",placeholder:"Rechercher par rÃ©fÃ©rence ou dÃ©signation...",value:w,onChange:t=>P(t.target.value),style:{flex:1,padding:"0.875rem 1rem",fontSize:"1rem",border:"2px solid var(--border-color)",borderRadius:"8px",background:"var(--input-bg)",color:"var(--text-color)",outline:"none",transition:"border-color 0.2s"},onFocus:t=>t.currentTarget.style.borderColor="var(--accent-color)",onBlur:t=>t.currentTarget.style.borderColor="var(--border-color)"}),e.jsx("select",{value:b,onChange:t=>L(t.target.value),style:{padding:"0.875rem 1rem",fontSize:"1rem",border:"2px solid var(--border-color)",borderRadius:"8px",background:"var(--bg-color)",color:"#ffffff",outline:"none",cursor:"pointer",minWidth:"200px",transition:"border-color 0.2s"},onFocus:t=>t.currentTarget.style.borderColor="var(--accent-color)",onBlur:t=>t.currentTarget.style.borderColor="var(--border-color)",children:M.map(t=>e.jsx("option",{value:t,style:{background:"var(--bg-color)",color:"#ffffff"},children:t==="all"?"Toutes les catÃ©gories":t==="top-ordered"?"Les plus utilisÃ©es":t},t))})]}),E.length===0?e.jsxs("div",{style:{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"40vh",gap:"1rem"},children:[e.jsxs("svg",{width:"60",height:"60",viewBox:"0 0 24 24",fill:"none",stroke:"var(--accent-color)",strokeWidth:"2",style:{animation:"spin 1s linear infinite"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",strokeLinecap:"round"})]}),e.jsx("p",{style:{fontSize:"1rem",color:"var(--text-secondary)",fontWeight:"500"},children:"Aucun produit dans cette catÃ©gorie"})]}):e.jsx("div",{className:"products-grid",children:E.map(t=>{const r=Q(t),n=f(t.id);return e.jsxs("div",{className:"product-card",children:[e.jsxs("div",{className:"product-image-wrapper",children:[e.jsx("span",{className:"product-category-badge",children:t.category}),t.photo?e.jsx("img",{src:t.photo,alt:t.designation,className:"product-image"}):e.jsx("div",{className:"product-image-placeholder",children:"ðŸ“¦"})]}),e.jsxs("div",{className:"product-details",children:[e.jsx("div",{className:"product-ref",children:t.reference}),e.jsx("h3",{className:"product-name",children:t.designation}),e.jsxs("div",{className:"product-stock-inline",children:["QuantitÃ© : ",e.jsx("span",{className:r,children:t.currentStock})]}),(()=>{const s=z(t.id);return e.jsx("span",{style:{display:"inline-block",padding:"0.125rem 0.5rem",fontSize:"0.7rem",fontWeight:"600",color:s>0?"#fff":"transparent",background:s>0?"#10b981":"transparent",borderRadius:"4px",marginTop:"0.25rem",width:"fit-content",visibility:s>0?"visible":"hidden"},children:s>0?`En commande x${s}`:"Spacer"})})(),e.jsxs("div",{className:"product-actions",children:[e.jsxs("div",{className:"quantity-selector",children:[e.jsx("button",{className:"quantity-btn",onClick:()=>F(t.id),disabled:n<=1,children:"âˆ’"}),e.jsx("input",{type:"number",className:"quantity-input",value:n,onChange:s=>S(t.id,parseInt(s.target.value)||1),min:"1",max:t.currentStock}),e.jsx("button",{className:"quantity-btn",onClick:()=>A(t.id),disabled:n>=t.currentStock,children:"+"})]}),t.currentStock>0?e.jsx("button",{className:"add-to-cart-btn-icon",onClick:()=>j(t.id),title:"Ajouter au panier",disabled:k[t.id],children:k[t.id]?e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",style:{animation:"spin 0.8s linear infinite"},children:[e.jsx("circle",{cx:"12",cy:"12",r:"10",opacity:"0.25"}),e.jsx("path",{d:"M12 2a10 10 0 0 1 10 10",strokeLinecap:"round"})]}):e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"9",cy:"21",r:"1"}),e.jsx("circle",{cx:"20",cy:"21",r:"1"}),e.jsx("path",{d:"M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"})]})}):e.jsx("button",{className:"add-to-cart-btn-icon",disabled:!0,title:"Stock Ã©puisÃ©",children:e.jsxs("svg",{width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("circle",{cx:"9",cy:"21",r:"1"}),e.jsx("circle",{cx:"20",cy:"21",r:"1"}),e.jsx("path",{d:"M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"})]})})]})]})]},t.id)})}),u.length>0&&e.jsxs("div",{className:"fixed-cart",children:[e.jsxs("div",{className:"cart-header",children:[e.jsx("h2",{children:"Mon Panier"}),e.jsxs("span",{className:"cart-count",children:[V()," articles"]})]}),e.jsx("div",{className:"cart-items",children:u.map(t=>e.jsxs("div",{className:"cart-item",children:[t.photo?e.jsx("img",{src:t.photo,alt:t.productDesignation,className:"cart-item-image"}):e.jsx("div",{className:"cart-item-image",children:"ðŸ“¦"}),e.jsxs("div",{className:"cart-item-details",children:[e.jsx("div",{className:"cart-item-ref product-reference-highlight",children:t.productReference}),e.jsx("div",{className:"cart-item-name",children:t.productDesignation}),e.jsxs("div",{className:"cart-item-quantity",children:[e.jsx("span",{children:"QuantitÃ©:"}),e.jsx("strong",{children:t.quantity})]})]}),e.jsx("button",{className:"remove-item-btn",onClick:()=>R(t.productId),title:"Retirer du panier",children:"Ã—"})]},t.productId))}),e.jsxs("div",{className:"cart-footer",children:[e.jsx("button",{className:"empty-cart-btn",onClick:a,children:"Vider le panier"}),e.jsx("button",{className:"submit-cart-btn",onClick:h,children:"Effectuer la sortie"})]})]}),v&&e.jsx(U,{cartItems:u,onComplete:$,onCancel:B})]})};export{J as default};
