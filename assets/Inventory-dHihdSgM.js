import{u as G,j as e,H as J}from"./index-DlynR0Vu.js";import{r as a,R as D}from"./react-vendor-D8CQoBvY.js";import"./supabase-BffQhpPo.js";const te=()=>{const{products:m,updateProduct:I,addStockMovement:$,currentUser:N}=G(),[u,R]=a.useState("full"),[p,Z]=a.useState(""),[x,B]=a.useState(""),[j,T]=a.useState(""),[c,v]=a.useState([]),[A,S]=a.useState(!1),[k,P]=a.useState(!1),[g,C]=a.useState(""),[V,E]=a.useState(null),M=D.useRef(null),[l,w]=a.useState(!1),i=D.useRef(null),h=a.useMemo(()=>m.filter(t=>{if(t.deletedAt||u==="category"&&p&&t.category!==p||u==="zone"&&x&&t.storageZone!==x)return!1;if(j){const n=j.toLowerCase();return t.reference.toLowerCase().includes(n)||t.designation.toLowerCase().includes(n)}return!0}),[m,u,p,x,j]),z=a.useMemo(()=>Array.from(new Set(m.map(t=>t.category).filter(Boolean))),[m]),L=a.useMemo(()=>Array.from(new Set(m.map(t=>t.storageZone).filter(Boolean))),[m]),q=a.useCallback(()=>{const t=h.map(n=>({productId:n.id,reference:n.reference,designation:n.designation,category:n.category,storageZone:n.storageZone,shelf:n.shelf,position:n.position,systemStock:n.currentStock,countedStock:null,difference:0,status:"pending",notes:""}));v(t),S(!0)},[h]),O=a.useCallback((t,n)=>{v(s=>s.map(r=>{if(r.productId===t){const f=n!==null?n-r.systemStock:0;return{...r,countedStock:n,difference:f,status:n!==null?"counted":"pending"}}return r}))},[]),H=a.useCallback((t,n)=>{v(s=>s.map(r=>r.productId===t?{...r,notes:n}:r))},[]),U=a.useCallback(t=>{v(n=>n.map(s=>s.productId===t?{...s,status:"validated"}:s))},[]),W=a.useCallback(async()=>{const t=c.filter(s=>s.status==="validated"&&s.difference!==0);if(t.length===0){alert("Aucun ajustement à effectuer");return}const n=`Vous allez ajuster ${t.length} produit(s).
Total écarts: ${t.reduce((s,r)=>s+Math.abs(r.difference),0)}

Confirmer l'ajustement ?`;if(window.confirm(n))try{for(const s of t)await I(s.productId,{currentStock:s.countedStock},!0),await $({productId:s.productId,productReference:s.reference,productDesignation:s.designation,movementType:"adjustment",quantity:Math.abs(s.difference),previousStock:s.systemStock,newStock:s.countedStock,userId:N.id,userName:N.name,reason:`Inventaire - ${s.notes||(s.difference>0?"Surplus détecté":"Manquant détecté")}`,notes:s.notes});alert(`✅ Inventaire validé!
${t.length} ajustement(s) effectué(s)`),S(!1),v([])}catch(s){console.error("Erreur lors de la validation:",s),alert("❌ Erreur lors de la validation de l'inventaire")}},[c,I,$,N]),o=a.useMemo(()=>{const t=c.length,n=c.filter(d=>d.status!=="pending").length,s=c.filter(d=>d.status==="validated").length,r=c.filter(d=>d.difference!==0).length,f=c.reduce((d,_)=>d+_.difference,0);return{total:t,counted:n,validated:s,withDifferences:r,totalDifference:f}},[c]),F=a.useMemo(()=>k?c.filter(t=>t.difference!==0):c,[c,k]),y=a.useCallback(t=>{if(!t.trim())return;const n=c.find(s=>s.reference.toLowerCase()===t.toLowerCase());if(n){E(n.productId),setTimeout(()=>E(null),2e3);const s=document.getElementById(`inventory-item-${n.productId}`);s&&s.scrollIntoView({behavior:"smooth",block:"center"}),setTimeout(()=>{const r=document.querySelector(`#count-input-${n.productId}`);r&&(r.focus(),r.select())},300)}else alert(`❌ Produit non trouvé: ${t}
Ce produit n'est pas dans la liste d'inventaire actuelle.`);C(""),setTimeout(()=>{var s;return(s=M.current)==null?void 0:s.focus()},100)},[c]),b=a.useCallback(async()=>{if(!(!i.current||!i.current.isScanning))try{await i.current.stop(),w(!1)}catch(t){console.error("Erreur lors de l'arrêt de la caméra:",t)}},[]);a.useEffect(()=>{if(!l)return;(async()=>{try{let n=0;const s=10;for(;n<s&&!document.getElementById("barcode-reader");)await new Promise(d=>setTimeout(d,100)),n++;if(!document.getElementById("barcode-reader"))throw new Error("Élément barcode-reader non trouvé après plusieurs tentatives");i.current||(i.current=new J("barcode-reader")),await i.current.start({facingMode:"environment"},{fps:10,qrbox:{width:250,height:250}},f=>{C(f),b(),y(f)},()=>{})}catch(n){console.error("Erreur lors du démarrage de la caméra:",n),alert("Impossible d'accéder à la caméra. Vérifiez les permissions."),w(!1)}})()},[l,y,b]),a.useEffect(()=>()=>{i.current&&i.current.isScanning&&i.current.stop().catch(console.error)},[]);const Q=a.useCallback(async()=>{w(!0)},[]),K=a.useCallback(()=>{const t=[["Référence","Désignation","Catégorie","Zone","Stock Système","Stock Compté","Écart","Statut","Notes"].join(";"),...c.map(r=>[r.reference,r.designation,r.category,r.storageZone||"",r.systemStock,r.countedStock??"",r.difference,r.status==="pending"?"Non compté":r.status==="counted"?"Compté":"Validé",r.notes].join(";"))].join(`
`),n=new Blob([t],{type:"text/csv;charset=utf-8;"}),s=document.createElement("a");s.href=URL.createObjectURL(n),s.download=`inventaire_${new Date().toISOString().split("T")[0]}.csv`,s.click()},[c]);return A?e.jsxs("div",{className:"inventory-page",children:[e.jsxs("div",{className:"inventory-header",children:[e.jsxs("div",{children:[e.jsx("h1",{children:"Inventaire en cours"}),e.jsx("p",{className:"subtitle",children:u==="full"?"Inventaire complet":u==="category"?`Catégorie: ${p}`:`Zone: ${x}`})]}),e.jsxs("div",{className:"header-actions",children:[e.jsx("button",{onClick:K,className:"btn btn-secondary",children:"Exporter CSV"}),e.jsx("button",{onClick:()=>{window.confirm("Abandonner l'inventaire en cours ?")&&(S(!1),v([]))},className:"btn btn-danger",children:"Abandonner"})]})]}),e.jsxs("div",{className:"inventory-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Total produits"}),e.jsx("p",{className:"stat-value",children:o.total})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Comptés"}),e.jsxs("p",{className:"stat-value",style:{color:"#10b981"},children:[o.counted," / ",o.total]})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Validés"}),e.jsx("p",{className:"stat-value",style:{color:"#3b82f6"},children:o.validated})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Écarts détectés"}),e.jsx("p",{className:"stat-value",style:{color:o.withDifferences>0?"#f59e0b":"var(--text-color)"},children:o.withDifferences})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h3",{children:"Écart total"}),e.jsxs("p",{className:"stat-value",style:{color:o.totalDifference!==0?"#ef4444":"var(--text-color)"},children:[o.totalDifference>0?"+":"",o.totalDifference]})]})]}),e.jsxs("div",{className:"barcode-scanner",children:[e.jsx("button",{onClick:l?b:Q,className:`btn btn-camera ${l?"scanning":""}`,title:l?"Arrêter la caméra":"Scanner avec la caméra",children:l?e.jsx("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:e.jsx("rect",{x:"6",y:"6",width:"12",height:"12"})}):e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"}),e.jsx("circle",{cx:"12",cy:"13",r:"4"})]})}),e.jsx("div",{className:"scanner-icon",children:e.jsxs("svg",{width:"24",height:"24",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("rect",{x:"3",y:"5",width:"2",height:"14"}),e.jsx("rect",{x:"7",y:"5",width:"1",height:"14"}),e.jsx("rect",{x:"10",y:"5",width:"2",height:"14"}),e.jsx("rect",{x:"14",y:"5",width:"1",height:"14"}),e.jsx("rect",{x:"17",y:"5",width:"3",height:"14"})]})}),e.jsx("input",{ref:M,type:"text",value:g,onChange:t=>C(t.target.value),onKeyDown:t=>{t.key==="Enter"&&y(g)},placeholder:"Scanner un code-barres ou saisir une référence...",className:"barcode-input",autoFocus:!0,disabled:l}),e.jsx("button",{onClick:()=>y(g),className:"btn btn-scan",disabled:!g.trim()||l,children:"Rechercher"})]}),l&&e.jsx("div",{className:"camera-scanner-container",children:e.jsxs("div",{className:"camera-scanner-overlay",children:[e.jsxs("div",{className:"camera-scanner-header",children:[e.jsx("h3",{children:"Scanner un code-barres"}),e.jsx("button",{onClick:b,className:"btn-close-camera",children:"✕"})]}),e.jsx("div",{id:"barcode-reader",className:"barcode-reader"}),e.jsx("p",{className:"camera-instructions",children:"Positionnez le code-barres dans le cadre"})]})}),e.jsxs("div",{className:"inventory-filters",children:[e.jsxs("label",{className:"checkbox-label",children:[e.jsx("input",{type:"checkbox",checked:k,onChange:t=>P(t.target.checked)}),"Afficher uniquement les écarts"]}),e.jsxs("button",{onClick:W,disabled:o.validated===0,className:"btn btn-primary",children:["Valider l'inventaire (",o.validated," produit",o.validated>1?"s":"",")"]})]}),e.jsx("div",{className:"inventory-list",children:F.map(t=>e.jsxs("div",{id:`inventory-item-${t.productId}`,className:`inventory-item ${t.status} ${t.difference!==0?"has-difference":""} ${V===t.productId?"scanned":""}`,children:[e.jsxs("div",{className:"item-info",children:[e.jsxs("div",{className:"item-header",children:[e.jsx("span",{className:"item-reference",children:t.reference}),e.jsx("span",{className:`item-status ${t.status}`,children:t.status==="pending"?"⏳ À compter":t.status==="counted"?"✓ Compté":"✓✓ Validé"})]}),e.jsx("div",{className:"item-designation",children:t.designation}),e.jsxs("div",{className:"item-details",children:[e.jsx("span",{children:t.category}),t.storageZone&&e.jsxs("span",{children:[t.storageZone,t.shelf&&` - ${t.shelf}`,t.position&&` - ${t.position}`]})]})]}),e.jsxs("div",{className:"item-counting",children:[e.jsxs("div",{className:"stock-info",children:[e.jsxs("div",{className:"stock-system",children:[e.jsx("label",{children:"Stock système"}),e.jsx("span",{className:"stock-value",children:t.systemStock})]}),e.jsxs("div",{className:"stock-counted",children:[e.jsx("label",{children:"Stock compté"}),e.jsx("input",{id:`count-input-${t.productId}`,type:"number",min:"0",value:t.countedStock??"",onChange:n=>O(t.productId,n.target.value?parseInt(n.target.value):null),placeholder:"0",className:"count-input",disabled:t.status==="validated"})]}),t.countedStock!==null&&e.jsxs("div",{className:`stock-difference ${t.difference>0?"positive":t.difference<0?"negative":""}`,children:[e.jsx("label",{children:"Écart"}),e.jsxs("span",{className:"difference-value",children:[t.difference>0?"+":"",t.difference]})]})]}),t.difference!==0&&t.status!=="validated"&&e.jsx("div",{className:"item-notes",children:e.jsx("input",{type:"text",placeholder:"Notes sur l'écart (optionnel)...",value:t.notes,onChange:n=>H(t.productId,n.target.value),className:"notes-input"})}),t.status==="counted"&&e.jsx("button",{onClick:()=>U(t.productId),className:"btn btn-validate",children:"Valider le comptage"})]})]},t.productId))})]}):e.jsxs("div",{className:"inventory-page",children:[e.jsx("h1",{children:"Mode Inventaire"}),e.jsx("p",{className:"subtitle",children:"Comptez physiquement vos produits et ajustez les stocks"}),e.jsx("div",{className:"inventory-setup",children:e.jsxs("div",{className:"setup-card",children:[e.jsx("h2",{children:"Configuration de l'inventaire"}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Type d'inventaire"}),e.jsxs("select",{value:u,onChange:t=>R(t.target.value),className:"form-control",children:[e.jsx("option",{value:"full",children:"Inventaire Complet"}),e.jsx("option",{value:"category",children:"Par Catégorie"}),e.jsx("option",{value:"zone",children:"Par Zone de Stockage"})]})]}),u==="category"&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Catégorie"}),e.jsxs("select",{value:p,onChange:t=>Z(t.target.value),className:"form-control",children:[e.jsx("option",{value:"",children:"Sélectionner une catégorie"}),z.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),u==="zone"&&e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Zone de stockage"}),e.jsxs("select",{value:x,onChange:t=>B(t.target.value),className:"form-control",children:[e.jsx("option",{value:"",children:"Sélectionner une zone"}),L.map(t=>e.jsx("option",{value:t,children:t},t))]})]}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{children:"Recherche (optionnel)"}),e.jsx("input",{type:"text",placeholder:"Filtrer par référence ou désignation...",value:j,onChange:t=>T(t.target.value),className:"form-control"})]}),e.jsxs("div",{className:"inventory-preview",children:[e.jsxs("h3",{children:["Produits à inventorier: ",h.length]}),h.length>0&&e.jsxs("div",{className:"preview-list",children:[h.slice(0,5).map(t=>e.jsxs("div",{className:"preview-item",children:[e.jsx("span",{className:"preview-ref",children:t.reference}),e.jsx("span",{className:"preview-name",children:t.designation}),e.jsxs("span",{className:"preview-stock",children:["Stock: ",t.currentStock]})]},t.id)),h.length>5&&e.jsxs("p",{className:"preview-more",children:["+ ",h.length-5," autres produits"]})]})]}),e.jsx("button",{onClick:q,disabled:h.length===0,className:"btn btn-primary btn-large",children:"Démarrer l'inventaire"})]})})]})};export{te as default};
