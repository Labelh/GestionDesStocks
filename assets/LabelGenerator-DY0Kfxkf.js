import{u as le,j as t}from"./index-DlynR0Vu.js";import{r as S}from"./react-vendor-D8CQoBvY.js";import{J as ce}from"./JsBarcode-DPx7lVFH.js";import{E as de}from"./heavy-libs-Bko_YaNF.js";import{s as L}from"./pdfTextUtils-D1ThJazT.js";import"./supabase-BffQhpPo.js";const pe=()=>{const{products:T}=le(),[d,z]=S.useState([]),[k,J]=S.useState(""),[F,O]=S.useState(""),[C,Q]=S.useState(""),[D,U]=S.useState(!0),h=S.useCallback(e=>e?e.replace(/Étagère\s*/gi,"").replace(/Position\s*/gi,"").replace(/\s*-\s*/g,"-").replace(/\.+/g,"-").replace(/-+/g,"-"):"",[]),V=S.useMemo(()=>Array.from(new Set(T.map(e=>e.location?h(e.location).split("-")[0]:"").filter(e=>e))).sort(),[T,h]),_=S.useMemo(()=>Array.from(new Set(T.map(e=>{if(!e.location)return"";const n=h(e.location).split("-");return n.length>=2?`${n[0]}-${n[1]}`:""}).filter(e=>e))).sort(),[T,h]),B=S.useMemo(()=>T.filter(e=>{const n=e.reference.toLowerCase().includes(k.toLowerCase())||e.designation.toLowerCase().includes(k.toLowerCase()),s=!F||e.location&&h(e.location).startsWith(F),u=!C||e.location&&h(e.location).startsWith(C);return n&&s&&u}),[T,k,F,C,h]),K=e=>{const n=d.find(s=>s.product.id===e.id);z(n?d.map(s=>s.product.id===e.id?{...s,quantity:s.quantity+1}:s):[...d,{product:e,quantity:1}])},ee=e=>{z(d.filter(n=>n.product.id!==e))},te=(e,n)=>{n<1||z(d.map(s=>s.product.id===e?{...s,quantity:n}:s))},se=()=>{if(!F)return;const e=B.filter(s=>s.location&&h(s.location).startsWith(F)),n=[...d];e.forEach(s=>{n.find(j=>j.product.id===s.id)||n.push({product:s,quantity:1})}),z(n)},ne=()=>{if(!C)return;const e=B.filter(s=>s.location&&h(s.location).startsWith(C)),n=[...d];e.forEach(s=>{n.find(j=>j.product.id===s.id)||n.push({product:s,quantity:1})}),z(n)},ie=()=>{const e=new de({orientation:"portrait",unit:"mm",format:"a4"}),n=210,s=297;let u,j,N,y,c,v;D?(u=4,j=12,N=52.5,y=24.75,c=2.5,v=2):(u=7,j=29,N=30,y=10,c=1.5,v=1);const oe=0,re=0,G=()=>{e.setDrawColor(200,200,200);const r=2,w=2;for(let i=1;i<u;i++){const a=i*N;let o=0;const f=s;for(;o<f;){const p=Math.min(o+r,f);e.line(a,o,a,p),o=p+w}}for(let i=1;i<j;i++){const a=i*y;let o=0;const f=n;for(;o<f;){const p=Math.min(o+r,f);e.line(o,a,p,a),o=p+w}}let m=0;for(;m<s;){const i=Math.min(m+r,s);e.line(0,m,0,i),m=i+w}for(m=0;m<s;){const i=Math.min(m+r,s);e.line(n,m,n,i),m=i+w}let x=0;for(;x<n;){const i=Math.min(x+r,n);e.line(x,0,i,0),x=i+w}for(x=0;x<n;){const i=Math.min(x+r,n);e.line(x,s,i,s),x=i+w}};let Y=0;G(),d.forEach(({product:r,quantity:w})=>{for(let m=0;m<w;m++){const x=Y%u,i=Math.floor(Y%(u*j)/u);Y>0&&Y%(u*j)===0&&(e.addPage(),G());const a=oe+x*N,o=re+i*y;if(D){const f=document.createElement("canvas");try{ce(f,r.reference,{format:"CODE128",width:1.5,height:40,displayValue:!1,margin:0});const p=f.toDataURL("image/png"),A=L(h(r.location)||"N/A");e.setFontSize(7);const I=e.getTextWidth(A),P=1,E=I+2*P,M=N-2*c-E-2;e.setTextColor(0,0,0),e.setFontSize(7),e.setFont("helvetica","normal");let g=L(r.designation);if(e.getTextWidth(g)>M){for(;e.getTextWidth(g+"...")>M&&g.length>0;)g=g.substring(0,g.length-1);g+="..."}const $=o+v+2.5;e.text(g,a+c,$),e.setTextColor(255,87,34),e.setFontSize(7),e.setFont("helvetica","bold");const q=o+v+7;e.text(L(r.reference),a+c,q);const W=5,l=a+N-c-E,R=o+v;e.setFillColor(220,220,220),e.roundedRect(l,R,E,W,.5,.5,"F"),e.setTextColor(0,0,0),e.setFontSize(7),e.setFont("helvetica","normal"),e.text(A,l+P,R+W/2+1.2);const Z=N-2*c,b=10,X=a+c,ae=o+y-b-v;e.addImage(p,"PNG",X,ae,Z,b)}catch(p){console.error("Error generating barcode for PDF:",p)}}else{const f=L(h(r.location)||"N/A");e.setFontSize(6.5);const p=e.getTextWidth(f),A=.6,I=p+2*A,P=3.5,E=a+N-c-I,M=o+y-v-P;e.setFillColor(220,220,220),e.roundedRect(E,M,I,P,.4,.4,"F"),e.setTextColor(0,0,0),e.setFontSize(6.5),e.setFont("helvetica","normal"),e.text(f,E+A,M+P/2+1);const g=N-2*c;e.setTextColor(0,0,0),e.setFontSize(6),e.setFont("helvetica","normal");const q=L(r.designation).split(" ");let W="",l="";for(let b=0;b<q.length;b++){const X=W?W+" "+q[b]:q[b];if(e.getTextWidth(X)<=g)W=X;else{l=q.slice(b).join(" ");break}}if(l&&e.getTextWidth(l)>g){for(;e.getTextWidth(l+"...")>g&&l.length>0;)l=l.substring(0,l.length-1);l+="..."}const R=o+v+2.5;if(e.text(W,a+c,R),l){const b=o+v+5.5;e.text(l,a+c,b)}e.setTextColor(255,87,34),e.setFontSize(6),e.setFont("helvetica","bold");const Z=o+y-v-.8;e.text(L(r.reference),a+c,Z)}Y++}}),e.save(`etiquettes_${new Date().toISOString().split("T")[0]}.pdf`)},H=()=>d.reduce((e,n)=>e+n.quantity,0);return t.jsxs("div",{className:"label-generator-page",children:[t.jsx("div",{className:"page-header",children:t.jsxs("div",{className:"page-title-section",children:[t.jsx("h1",{children:"Générateur d'Étiquettes"}),t.jsx("p",{className:"page-subtitle",children:"Créez et imprimez vos étiquettes de produits"})]})}),t.jsxs("div",{className:"generator-container",children:[t.jsxs("div",{className:"products-selection",children:[t.jsx("h2",{children:"Sélectionner les Produits"}),t.jsx("input",{type:"text",placeholder:"Rechercher par référence ou désignation...",value:k,onChange:e=>J(e.target.value),className:"search-input"}),t.jsxs("div",{className:"filter-section",children:[t.jsxs("select",{value:F,onChange:e=>O(e.target.value),className:"zone-filter",children:[t.jsx("option",{value:"",children:"Toutes les zones"}),V.map(e=>t.jsx("option",{value:e,children:e},e))]}),F&&t.jsx("button",{onClick:se,className:"btn-select-zone",title:"Sélectionner tous les produits de cette zone",children:"Sélectionner toute la zone"})]}),t.jsxs("div",{className:"filter-section",children:[t.jsxs("select",{value:C,onChange:e=>Q(e.target.value),className:"zone-filter",children:[t.jsx("option",{value:"",children:"Tous les tiroirs"}),_.map(e=>t.jsx("option",{value:e,children:e},e))]}),C&&t.jsx("button",{onClick:ne,className:"btn-select-zone",title:"Sélectionner tous les produits de ce tiroir",children:"Sélectionner tout le tiroir"})]}),t.jsx("div",{className:"products-list",children:B.map(e=>t.jsxs("div",{className:"product-item",children:[t.jsxs("div",{className:"product-info",children:[t.jsx("div",{className:"product-ref",children:e.reference}),t.jsx("div",{className:"product-name",children:e.designation}),t.jsx("div",{className:"product-location",children:h(e.location)||"N/A"})]}),t.jsx("button",{onClick:()=>K(e),className:"btn-add",title:"Ajouter",children:"+"})]},e.id))})]}),t.jsxs("div",{className:"selected-products",children:[t.jsxs("h2",{children:["Produits Sélectionnés (",H()," étiquettes)"]}),d.length===0?t.jsx("p",{className:"no-selection",children:"Aucun produit sélectionné"}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"selected-list",children:d.map(({product:e,quantity:n})=>t.jsxs("div",{className:"selected-item",children:[t.jsxs("div",{className:"selected-info",children:[t.jsx("div",{className:"selected-ref",children:e.reference}),t.jsx("div",{className:"selected-name",children:e.designation})]}),t.jsxs("div",{className:"selected-controls",children:[t.jsx("input",{type:"number",min:"1",value:n,onChange:s=>te(e.id,parseInt(s.target.value)||1),className:"quantity-input"}),t.jsx("button",{onClick:()=>ee(e.id),className:"btn-remove",title:"Retirer",children:"×"})]})]},e.id))}),t.jsxs("div",{className:"preview-actions",children:[t.jsxs("div",{className:"barcode-option",style:{display:"flex",alignItems:"center",gap:"0.75rem",padding:"1rem",background:"var(--card-bg)",borderRadius:"8px",border:"1px solid var(--border-color)",marginBottom:"1rem"},children:[t.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.5rem",cursor:"pointer",fontSize:"1rem",fontWeight:"500"},children:[t.jsx("input",{type:"checkbox",checked:D,onChange:e=>U(e.target.checked),style:{width:"18px",height:"18px",cursor:"pointer"}}),t.jsx("span",{children:"Inclure les codes-barres"})]}),t.jsx("div",{style:{fontSize:"0.875rem",color:"var(--text-secondary)",marginLeft:"0.5rem"},children:D?"(Format: 52.5mm × 24.75mm - 48 étiquettes/page)":"(Format: 30mm × 10mm - 203 étiquettes/page)"})]}),t.jsxs("button",{onClick:ie,className:"btn btn-primary",disabled:d.length===0,children:["Générer le PDF (",H()," étiquettes)"]})]})]})]})]})]})};export{pe as default};
