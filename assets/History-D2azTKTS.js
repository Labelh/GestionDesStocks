import{u as w,j as e}from"./index-CXtSVrVw.js";import{r,R as T}from"./react-vendor-DRM3MNr6.js";import{E as M,u as m,w as D}from"./heavy-libs-Dn1T2gkY.js";import{a as P}from"./jspdf.plugin.autotable-CtA5BUKo.js";import"./supabase-g_Un6fVd.js";const E=()=>{const{stockMovements:g,products:p}=w(),[l,v]=r.useState(""),[c,y]=r.useState(""),[h,j]=r.useState(1),u=25,a=r.useMemo(()=>g.filter(t=>{const s=!l||t.productId===l,d=!c||t.movementType===c;return s&&d}),[g,l,c]),o=r.useCallback(t=>{switch(t){case"entry":return"Entrée";case"exit":return"Sortie";case"adjustment":return"Ajustement";case"initial":return"Initial";default:return t}},[]),f=r.useCallback(t=>{switch(t){case"entry":return"movement-entry";case"exit":return"movement-exit";case"adjustment":return"movement-adjustment";case"initial":return"movement-initial";default:return""}},[]),S=r.useCallback(()=>{const t=new M;t.setFontSize(20),t.text("Historique des Mouvements de Stock",14,22),t.setFontSize(10),t.text(`Généré le ${new Date().toLocaleDateString("fr-FR")} à ${new Date().toLocaleTimeString("fr-FR")}`,14,30);let s=36;if(t.setFontSize(9),l||c){if(t.text("Filtres appliqués:",14,s),s+=5,l){const n=p.find(i=>i.id===l);t.text(`- Produit: ${(n==null?void 0:n.designation)||"N/A"}`,14,s),s+=5}c&&(t.text(`- Type: ${o(c)}`,14,s),s+=5),s+=3}const d=a.map(n=>[new Date(n.timestamp).toLocaleString("fr-FR"),n.productReference,n.productDesignation,o(n.movementType),n.quantity.toString(),n.previousStock.toString(),n.newStock.toString(),n.userName]);P(t,{startY:s,head:[["Date/Heure","Référence","Produit","Type","Quantité","Stock avant","Stock après","Utilisateur"]],body:d,styles:{fontSize:8},headStyles:{fillColor:[197,90,58]}}),t.save(`historique_stock_${new Date().toISOString().split("T")[0]}.pdf`)},[a,p,l,c,o]),b=r.useCallback(()=>{const t=a.map(i=>({"Date/Heure":new Date(i.timestamp).toLocaleString("fr-FR"),Référence:i.productReference,Produit:i.productDesignation,Type:o(i.movementType),Quantité:i.quantity,"Stock avant":i.previousStock,"Stock après":i.newStock,Utilisateur:i.userName})),s=m.json_to_sheet(t),d=m.book_new();m.book_append_sheet(d,s,"Historique");const n=t.reduce((i,N)=>Math.max(i,N["Date/Heure"].length),10);s["!cols"]=[{wch:n},{wch:12},{wch:30},{wch:12},{wch:10},{wch:12},{wch:12},{wch:15}],D(d,`historique_stock_${new Date().toISOString().split("T")[0]}.xlsx`)},[a,o]),x=r.useMemo(()=>Math.ceil(a.length/u),[a.length,u]),k=r.useMemo(()=>{const t=(h-1)*u,s=t+u;return a.slice(t,s)},[a,h,u]);return T.useEffect(()=>{j(1)},[l,c]),e.jsxs("div",{className:"history-page",children:[e.jsx("h1",{children:"Historique"}),e.jsxs("div",{className:"movements-stats",children:[e.jsxs("div",{className:"stat-card",children:[e.jsx("h4",{children:"Total des mouvements"}),e.jsx("span",{className:"stat-value",children:a.length})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h4",{children:"Entrées"}),e.jsx("span",{className:"stat-value entry",children:a.filter(t=>t.movementType==="entry").length})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h4",{children:"Sorties"}),e.jsx("span",{className:"stat-value exit",children:a.filter(t=>t.movementType==="exit").length})]}),e.jsxs("div",{className:"stat-card",children:[e.jsx("h4",{children:"Ajustements"}),e.jsx("span",{className:"stat-value adjustment",children:a.filter(t=>t.movementType==="adjustment").length})]})]}),e.jsxs("div",{className:"filters-with-export",style:{marginBottom:"2rem"},children:[e.jsxs("div",{className:"filters-left",children:[e.jsxs("select",{value:l,onChange:t=>v(t.target.value),className:"filter-select",children:[e.jsx("option",{value:"",children:"Tous les produits"}),p.map(t=>e.jsxs("option",{value:t.id,children:[t.reference," - ",t.designation]},t.id))]}),e.jsxs("select",{value:c,onChange:t=>y(t.target.value),className:"filter-select",children:[e.jsx("option",{value:"",children:"Tous les types"}),e.jsx("option",{value:"entry",children:"Entrée"}),e.jsx("option",{value:"exit",children:"Sortie"}),e.jsx("option",{value:"adjustment",children:"Ajustement"}),e.jsx("option",{value:"initial",children:"Initial"})]}),e.jsx("button",{onClick:()=>{v(""),y("")},className:"btn btn-secondary",children:"Réinitialiser"})]}),e.jsxs("div",{className:"export-buttons-right",children:[e.jsxs("button",{onClick:S,className:"btn btn-secondary",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("path",{d:"M14 2v6h6M16 13H8M16 17H8M10 9H8"})]}),"PDF"]}),e.jsxs("button",{onClick:b,className:"btn btn-secondary",children:[e.jsxs("svg",{width:"16",height:"16",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",children:[e.jsx("path",{d:"M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"}),e.jsx("path",{d:"M14 2v6h6M12 18v-6M9 15l3 3 3-3"})]}),"Excel"]})]})]}),a.length===0?e.jsx("p",{className:"no-data",children:"Aucun mouvement trouvé"}):e.jsxs("div",{className:"movements-table-container",children:[e.jsxs("table",{className:"movements-table",children:[e.jsx("thead",{children:e.jsxs("tr",{children:[e.jsx("th",{children:"Date/Heure"}),e.jsx("th",{children:"Produit"}),e.jsx("th",{children:"Type"}),e.jsx("th",{children:"Quantité"}),e.jsx("th",{children:"Stock avant"}),e.jsx("th",{children:"Stock après"}),e.jsx("th",{children:"Utilisateur"})]})}),e.jsx("tbody",{children:k.map(t=>e.jsxs("tr",{className:f(t.movementType),children:[e.jsxs("td",{className:"date-cell",children:[new Date(t.timestamp).toLocaleDateString("fr-FR"),e.jsx("br",{}),e.jsx("small",{children:new Date(t.timestamp).toLocaleTimeString("fr-FR")})]}),e.jsxs("td",{children:[e.jsx("strong",{children:t.productReference}),e.jsx("br",{}),e.jsx("small",{children:t.productDesignation})]}),e.jsx("td",{children:e.jsx("span",{className:`type-badge ${f(t.movementType)}`,children:o(t.movementType)})}),e.jsxs("td",{className:"quantity-cell",children:[t.movementType==="exit"?"-":"+",t.quantity]}),e.jsx("td",{children:t.previousStock}),e.jsx("td",{children:e.jsx("strong",{children:t.newStock})}),e.jsx("td",{children:t.userName})]},t.id))})]}),x>1&&e.jsxs("div",{className:"pagination",children:[e.jsx("button",{onClick:()=>j(t=>Math.max(1,t-1)),disabled:h===1,className:"btn btn-secondary",children:"← Précédent"}),e.jsxs("div",{className:"pagination-info",children:["Page ",h," sur ",x," (",a.length," mouvements)"]}),e.jsx("button",{onClick:()=>j(t=>Math.min(x,t+1)),disabled:h===x,className:"btn btn-secondary",children:"Suivant →"})]})]})]})};export{E as default};
