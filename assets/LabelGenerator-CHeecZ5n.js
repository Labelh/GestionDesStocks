import{u as de,j as t}from"./index-BHdnVhBT.js";import{r as l}from"./react-vendor-DRM3MNr6.js";import{J as H}from"./JsBarcode-CmyaEkaf.js";import{E as he}from"./heavy-libs-Dn1T2gkY.js";import"./supabase-g_Un6fVd.js";const ve=()=>{const{products:p}=de(),[i,j]=l.useState([]),[S,O]=l.useState(""),[g,B]=l.useState(""),[x,J]=l.useState(""),[E,z]=l.useState(!1),A=l.useRef({}),o=l.useCallback(e=>e?e.replace(/Étagère\s*/gi,"").replace(/Position\s*/gi,"").replace(/\s*-\s*/g,"-").replace(/\.+/g,"-").replace(/-+/g,"-"):"",[]),V=l.useMemo(()=>Array.from(new Set(p.map(e=>e.location?o(e.location).split("-")[0]:"").filter(e=>e))).sort(),[p,o]),Q=l.useMemo(()=>Array.from(new Set(p.map(e=>{if(!e.location)return"";const n=o(e.location).split("-");return n.length>=2?`${n[0]}-${n[1]}`:""}).filter(e=>e))).sort(),[p,o]),q=l.useMemo(()=>p.filter(e=>{const n=e.reference.toLowerCase().includes(S.toLowerCase())||e.designation.toLowerCase().includes(S.toLowerCase()),s=!g||e.location&&o(e.location).startsWith(g),a=!x||e.location&&o(e.location).startsWith(x);return n&&s&&a}),[p,S,g,x,o]),U=e=>{const n=i.find(s=>s.product.id===e.id);j(n?i.map(s=>s.product.id===e.id?{...s,quantity:s.quantity+1}:s):[...i,{product:e,quantity:1}])},_=e=>{j(i.filter(n=>n.product.id!==e))},K=(e,n)=>{n<1||j(i.map(s=>s.product.id===e?{...s,quantity:n}:s))},ee=()=>{if(!g)return;const e=q.filter(s=>s.location&&o(s.location).startsWith(g)),n=[...i];e.forEach(s=>{n.find(r=>r.product.id===s.id)||n.push({product:s,quantity:1})}),j(n)},te=()=>{if(!x)return;const e=q.filter(s=>s.location&&o(s.location).startsWith(x)),n=[...i];e.forEach(s=>{n.find(r=>r.product.id===s.id)||n.push({product:s,quantity:1})}),j(n)};l.useEffect(()=>{E&&setTimeout(()=>{i.forEach(({product:e,quantity:n})=>{for(let s=0;s<n;s++){const a=`${e.id}-${s}`,r=A.current[a];if(r)try{H(r,e.reference,{format:"CODE128",width:1.5,height:30,displayValue:!1,margin:0})}catch(b){console.error("Error generating barcode:",b)}}})},100)},[E,i]);const se=()=>{z(!0)},ne=()=>{const e=new he({orientation:"portrait",unit:"mm",format:"a4"}),n=210,s=297,a=4,r=12,b=0,ae=0,y=52.5,N=24.75,F=1.5,M=()=>{e.setDrawColor(200,200,200);const f=2,P=2;for(let d=1;d<=a;d++){const v=d*y;let c=0;const h=s;for(;c<h;){const m=Math.min(c+f,h);e.line(v,c,v,m),c=m+P}}for(let d=1;d<=r;d++){const v=d*N;let c=0;const h=n;for(;c<h;){const m=Math.min(c+f,h);e.line(c,v,m,v),c=m+P}}};let w=0;M(),i.forEach(({product:f,quantity:P})=>{for(let d=0;d<P;d++){const v=w%a,c=Math.floor(w%(a*r)/a);w>0&&w%(a*r)===0&&(e.addPage(),M());const h=b+v*y,m=ae+c*N,R=document.createElement("canvas");try{H(R,f.reference,{format:"CODE128",width:1.5,height:40,displayValue:!1,margin:0});const T=R.toDataURL("image/png"),k=22,I=8,re=m+(N-I)/2;e.addImage(T,"PNG",h+F,re,k,I);const W=h+F+k+2,Y=o(f.location)||"N/A";e.setFontSize(5.5);const oe=e.getTextWidth(Y),$=1,D=oe+2*$,X=y-(W-h)-F-D-2;e.setTextColor(0,0,0),e.setFontSize(6),e.setFont("helvetica","normal");let u=f.designation;if(e.getTextWidth(u)>X){for(;e.getTextWidth(u+"...")>X&&u.length>0;)u=u.substring(0,u.length-1);u+="..."}const ce=m+N/2-.5;e.text(u,W,ce),e.setTextColor(255,87,34),e.setFontSize(6.5),e.setFont("helvetica","bold");const le=m+N/2+2.5;e.text(f.reference,W,le);const L=3.5,Z=h+y-F-D,G=m+(N-L)/2;e.setFillColor(220,220,220),e.roundedRect(Z,G,D,L,.5,.5,"F"),e.setTextColor(0,0,0),e.setFontSize(5.5),e.setFont("helvetica","normal"),e.text(Y,Z+$,G+L/2+1)}catch(T){console.error("Error generating barcode for PDF:",T)}w++}}),e.save(`etiquettes_${new Date().toISOString().split("T")[0]}.pdf`)},C=()=>i.reduce((e,n)=>e+n.quantity,0),ie=()=>{const e=[];return i.forEach(({product:n,quantity:s})=>{for(let a=0;a<s;a++){const r=`${n.id}-${a}`;e.push(t.jsxs("div",{className:"label-preview",children:[t.jsx("canvas",{ref:b=>{b&&(A.current[r]=b)},className:"label-barcode"}),t.jsxs("div",{className:"label-header",children:[t.jsx("div",{className:"label-reference",children:n.reference}),t.jsx("div",{className:"label-location",children:o(n.location)||"N/A"})]}),t.jsx("div",{className:"label-designation",children:n.designation})]},r))}}),e};return E?t.jsxs("div",{className:"label-generator-page",children:[t.jsxs("div",{className:"page-header",children:[t.jsx("h1",{children:"Prévisualisation des Étiquettes"}),t.jsxs("div",{className:"header-actions",children:[t.jsx("button",{onClick:()=>z(!1),className:"btn btn-secondary",children:"← Retour"}),t.jsx("button",{onClick:ne,className:"btn btn-primary",children:"Générer le PDF"})]})]}),t.jsxs("div",{className:"preview-info",children:[t.jsxs("p",{children:["Total: ",t.jsxs("strong",{children:[C()," étiquettes"]})]}),t.jsxs("p",{children:["Pages: ",t.jsx("strong",{children:Math.ceil(C()/48)})]}),t.jsx("p",{className:"preview-note",children:"Format: 4 colonnes × 12 lignes (48 étiquettes par page)"})]}),t.jsx("div",{className:"labels-grid",children:ie()})]}):t.jsxs("div",{className:"label-generator-page",children:[t.jsx("div",{className:"page-header",children:t.jsxs("div",{className:"page-title-section",children:[t.jsx("h1",{children:"Générateur d'Étiquettes"}),t.jsx("p",{className:"page-subtitle",children:"Créez et imprimez vos étiquettes de produits"})]})}),t.jsxs("div",{className:"generator-container",children:[t.jsxs("div",{className:"products-selection",children:[t.jsx("h2",{children:"Sélectionner les Produits"}),t.jsx("input",{type:"text",placeholder:"Rechercher par référence ou désignation...",value:S,onChange:e=>O(e.target.value),className:"search-input"}),t.jsxs("div",{className:"filter-section",children:[t.jsxs("select",{value:g,onChange:e=>B(e.target.value),className:"zone-filter",children:[t.jsx("option",{value:"",children:"Toutes les zones"}),V.map(e=>t.jsx("option",{value:e,children:e},e))]}),g&&t.jsx("button",{onClick:ee,className:"btn-select-zone",title:"Sélectionner tous les produits de cette zone",children:"Sélectionner toute la zone"})]}),t.jsxs("div",{className:"filter-section",children:[t.jsxs("select",{value:x,onChange:e=>J(e.target.value),className:"zone-filter",children:[t.jsx("option",{value:"",children:"Tous les tiroirs"}),Q.map(e=>t.jsx("option",{value:e,children:e},e))]}),x&&t.jsx("button",{onClick:te,className:"btn-select-zone",title:"Sélectionner tous les produits de ce tiroir",children:"Sélectionner tout le tiroir"})]}),t.jsx("div",{className:"products-list",children:q.map(e=>t.jsxs("div",{className:"product-item",children:[t.jsxs("div",{className:"product-info",children:[t.jsx("div",{className:"product-ref",children:e.reference}),t.jsx("div",{className:"product-name",children:e.designation}),t.jsx("div",{className:"product-location",children:o(e.location)||"N/A"})]}),t.jsx("button",{onClick:()=>U(e),className:"btn-add",title:"Ajouter",children:"+"})]},e.id))})]}),t.jsxs("div",{className:"selected-products",children:[t.jsxs("h2",{children:["Produits Sélectionnés (",C()," étiquettes)"]}),i.length===0?t.jsx("p",{className:"no-selection",children:"Aucun produit sélectionné"}):t.jsxs(t.Fragment,{children:[t.jsx("div",{className:"selected-list",children:i.map(({product:e,quantity:n})=>t.jsxs("div",{className:"selected-item",children:[t.jsxs("div",{className:"selected-info",children:[t.jsx("div",{className:"selected-ref",children:e.reference}),t.jsx("div",{className:"selected-name",children:e.designation})]}),t.jsxs("div",{className:"selected-controls",children:[t.jsx("input",{type:"number",min:"1",value:n,onChange:s=>K(e.id,parseInt(s.target.value)||1),className:"quantity-input"}),t.jsx("button",{onClick:()=>_(e.id),className:"btn-remove",title:"Retirer",children:"×"})]})]},e.id))}),t.jsx("div",{className:"preview-actions",children:t.jsxs("button",{onClick:se,className:"btn btn-primary",disabled:i.length===0,children:["Prévisualiser (",C()," étiquettes)"]})})]})]})]})]})};export{ve as default};
